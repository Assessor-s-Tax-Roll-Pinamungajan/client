
<ng-template #loadingTpl>
  <div style="display:flex; align-items:center; justify-content:center; padding: 48px;">
    <mat-progress-spinner mode="indeterminate" diameter="56"></mat-progress-spinner>
  </div>
</ng-template>

<div class="land-details" *ngIf="!isLoading && land; else loadingTpl">
  <div class="header-section">
    <h2>Land Record Details</h2>
    <button 
      mat-raised-button color="primary" 
      (click)="onUpdateDialog(land)" 
      class="update-button">
      <mat-icon>edit</mat-icon>
      Update
    </button>
  </div>
  
  <div class="tax-map-header">
            <p class="index-line">
              <strong>INDEX NO.</strong> <span class="index-value">{{ land.index_no }}</span>
            </p>
            <p class="brgy-section">Brgy. Section</p>
            <p class="pin-section">PIN: 043-33-{{ land.index_no }}- {{ land.assessor_no }}</p>
            <!-- <p >Cancel value: {{ land.cancel }}</p> -->

            <div class="title-block">
              <h1>TAX MAP CONTROL ROLL</h1>
              <div *ngIf="land.cancel_reason" class="cancel-notice">
                <ng-container *ngIf="land.cancel_reason === 'subdivision' && land.cancel_details?.lots?.length > 0; else otherCancel">
                  ⚠️ This record has been marked as <strong>CANCELLED</strong> due to <strong>SUBDIVISION</strong>
                  (
                  <ng-container *ngFor="let lot of land.cancel_details.lots; let last = last">
                    <a [routerLink]="['/land-details', lot.id]">{{ lot.assessor_no }}</a><span *ngIf="!last">, </span>
                  </ng-container>
                  ).
                </ng-container>
                <ng-template #otherCancel>
                  {{ getCancelNotice() }}
                  <ng-container *ngIf="['transfer', 'duplicate', 'consolidate'].includes(land.cancel_reason) && land.cancel_details?.lots?.length > 0">
                    (<ng-container *ngFor="let lot of land.cancel_details.lots; let last = last">
                      <a [routerLink]="['/land-details', lot.id]">{{ lot.assessor_no }}</a><span *ngIf="!last">, </span>
                    </ng-container>).
                  </ng-container>
                </ng-template>
              </div>

              <!-- Transfer notice - when this lot came from another lot -->
              <div *ngIf="land.transferred_from" class="transfer-notice">
                ℹ️ This LOT came from the LOT of Assessor No. 
                <a [routerLink]="['/land-details', land.transferred_from.id]">{{ land.transferred_from.assessor_no }}</a>
              </div>

    <div >
      <div class="index-value">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CEBU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
      <div class="under">PROVINCE/CITY</div>
      <div class="index-value">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PINAMUNGAJAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
      <div class="under">MUNICIPALITY/DISTRICT</div>
    </div>

  </div>

  <!-- table -->
  <table class="land-table" [ngClass]="{ 'cancelled-table': land.cancel_reason }">


    <thead>
      <tr>
        <th rowspan="2">Assessors Lot No.</th>
        <th rowspan="2">Cadastral Lot No.</th>
        <th rowspan="2">TD No.</th>
        <th colspan="6">ARP</th>
        <th rowspan="2">Name of Owner</th>
        <th>Title No.</th>
        <th>Area (sq.m.)</th>
        <th rowspan="2">Classification Code</th>
        <th colspan="2">Improvement (Number of Buildings)</th>
        <th rowspan="2">Mch</th> 
        <th rowspan="2">Oth</th>
      </tr>
      <tr class="sub-header">
        <td>A</td>
        <td>B</td>
        <td>C</td>
        <td>D</td>
        <td>E</td>
        <td>F</td>
        <td>#</td>
        <td>#</td>
        <td>/</td>
        <td>/</td>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let lot of tableLots" 
          [ngClass]="{ 'cancelled-row': lot.isCanceled, 'reference-row': lot.isReferenceLot }"
          [routerLink]="lot.isReferenceLot ? ['/land-details', lot.id] : null"
          [style.cursor]="lot.isReferenceLot ? 'pointer' : 'default'">
        <td>{{ lot.assessor_no }}</td>
        <td>{{ lot.cadastral_no }}</td>
        <td>{{ lot.td_no }}</td>
        <td>{{ lot.arp_A }}</td>
        <td>{{ lot.arp_B }}</td>
        <td>{{ lot.arp_C }}</td>
        <td>{{ lot.arp_D }}</td>
        <td>{{ lot.arp_E }}</td>
        <td>{{ lot.arp_F }}</td>
        <td>{{ lot.name_owner }}</td>
        <td>{{ lot.title_no }}</td>
        <td>{{ lot.area }}</td>
        <td>{{ lot.classification_no }}</td>
        <td>{{ lot.improvement_1 }}</td>
        <td>{{ lot.improvement_2 }}</td>
        <td>{{ lot.mch }}</td>
        <td>{{ lot.oth }}</td>
      </tr>
    </tbody>
  </table>
  <div class="bot-container" >
    <!-- ✅ Image on the left, 70% width -->

  <div class="left-section; ">
        <div style="flex: 0 0 50%; display: flex; margin-bottom: 24px;">
          <img
            *ngIf="land.barangay && land.index_no && land.assessor_no"
            [src]="'assets/' + land.barangay.toUpperCase() + '/'+ land.index_no + '/' + land.assessor_no + '.png'"
            alt="Lot Photo should be found at client/src/assets/barangay/index_no/assessor_no.png"
            style="display: block; max-width: 90%; height: auto;"
          />
        </div>

        <div style="flex: 0 0 50%; display: flex;">
          <img
            *ngIf="land.barangay && land.index_no && land.assessor_no"
            [src]="'assets/' + land.barangay.toUpperCase() + '/'+ land.barangay.toUpperCase() + '.png'"
            alt="Barangay Photo should be found at client/src/assets/barangay/barangay.png"
            style="display: block; max-width: 90%; height: auto;"
          />
        </div>
  </div>

  <div class="right-section">
  
      <div class="other-lots-section" style="flex: 0 0 40; margin-bottom: 24px;">
        <div *ngIf="otherLots.length > 0" class="other-lots-table">
          <h3>Other Lots in Index {{ land.index_no }}</h3>
          <div class="table-container">
              <table mat-table [dataSource]="otherLots" class="other-lots-table">
                <!-- Assessor No Column -->
                <ng-container matColumnDef="assessor_no" >
                  <th mat-header-cell *matHeaderCellDef>Assessor Lot No.</th>
                  <td mat-cell *matCellDef="let lot">{{ lot.assessor_no }}</td>
                </ng-container>

                <!-- Owner Name Column -->
                <ng-container matColumnDef="name_owner">
                  <th mat-header-cell *matHeaderCellDef>Name of Owner</th>
                  <td mat-cell *matCellDef="let lot">{{ lot.name_owner }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['assessor_no', 'name_owner']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['assessor_no', 'name_owner'];" 
                    [routerLink]="['/land-details', row.id]"></tr>
              </table>
          </div>
        </div>
        
        <div *ngIf="!isLoadingOtherLots && otherLots.length === 0 && land.index_no" class="no-other-lots">
          <p>No other lots found in index {{ land.index_no }}</p>
        </div>
        
        <div *ngIf="isLoadingOtherLots" class="loading-other-lots">
          <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
          <span>Loading other lots...</span>
        </div>
      </div>

      <div class="remarks-section" style="flex: 0 0 100%;">
          <div *ngIf="land.remarks && land.remarks.trim() !== ''" class="remarks-block" style="width: 100%;">
            <h3>Remarks:</h3>
            <p>{{ land.remarks }}</p>
          </div>
          
          <div *ngIf="land.changes && land.changes.trim() !== ''" class="changes-block" style="width: 100%;">
            <h3>Changes:</h3>
            <p>{{ land.changes }}</p>
          </div>
      </div>

  </div>


  </div>
    

</div>
